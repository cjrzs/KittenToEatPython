<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="小猫咪吃python" href="http://yoursite.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="小猫咪吃python" href="http://yoursite.com/atom.xml"><link rel="alternate" type="application/json" title="小猫咪吃python" href="http://yoursite.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/css/app.css?v=0.2.5"><meta name="keywords" content="经典必会,AcWing算法提高课,线段树"><link rel="canonical" href="http://yoursite.com/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%94%BB%E7%95%A52.0%EF%BC%88%E4%B8%8B%EF%BC%89/"><title>看完必会的线段树攻略2.0（下） - 数据结构 - 算法 | The Cat to eat Python = 小猫咪吃python = 唤起一天明月 照我满怀冰雪 浩荡百川流 鲸饮未吞海 剑气已横秋</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">看完必会的线段树攻略2.0（下）</h1><div class="meta"><span class="item" title="创建时间：2022-11-11 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-11-11T00:00:00+08:00">2022-11-11</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>6.7k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>6 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">The Cat to eat Python</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclize41wj20zk0m87gk.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giciukx8a7j20zk0m8aio.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipesng5oej20zk0m87d4.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipewf5l51j20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclxxcb6rj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclxfdlttj20zk0m8npd.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="item" rel="index" title="分类于 算法"><span itemprop="name">算法</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="item" rel="index" title="分类于 数据结构"><span itemprop="name">数据结构</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://yoursite.com/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%94%BB%E7%95%A52.0%EF%BC%88%E4%B8%8B%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/images/avatar.jpg"><meta itemprop="name" content="A Cat Without Sugar"><meta itemprop="description" content="唤起一天明月 照我满怀冰雪 浩荡百川流 鲸饮未吞海 剑气已横秋, 孤独与剑，自由与酒"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小猫咪吃python"></span><div class="body md" itemprop="articleBody"><h1 id="前置知识"><a class="anchor" href="#前置知识">#</a> 前置知识</h1><p>接前文：<span class="exturl" data-url="aHR0cHM6Ly9janJ6cy5naXRodWIuaW8vJUU3JTlDJThCJUU1JUFFJThDJUU1JUJGJTg1JUU0JUJDJTlBJUU3JTlBJTg0JUU3JUJBJUJGJUU2JUFFJUI1JUU2JUEwJTkxJUU2JTk0JUJCJUU3JTk1JUE1Mi4wJUVGJUJDJTg4JUU0JUI4JThBJUVGJUJDJTg5Lw==">看完必会的线段树攻略 2.0（上）</span>。</p><p>在前文中，着重讲解了<strong>线段树的 单点修改 和 区间查询</strong>两个操作，并没有涉及到<strong>区间修改</strong>，因此在本文中将之补充。</p><h1 id="线段树"><a class="anchor" href="#线段树">#</a> 线段树</h1><p>简单回顾一下前文的内容。</p><p>在<strong>单点修改</strong>中，使用的方法是<strong>先找到这个元素所在的叶子节点，从叶子节点 pushup 一遍，更新 它的所有祖先节点</strong>。而这个<strong> pushup</strong> 操作，因为要从叶子节点更新到根节点，所以该操作是和树高度成正比的，因此时间复杂度是 <code>O(logn)</code> 。</p><p>如果延续<strong>单点修改</strong>的思路到<strong>区间修改</strong>，假设需要修改的区间有 n 个元素，那么时间复杂度将会来到 <code>O(nlogn)</code> ，这是非常慢的。所以线段树在做<strong>区间修改</strong>的时候需要用到一个小技巧 --<strong> 懒标记</strong>。</p><h2 id="懒标记"><a class="anchor" href="#懒标记">#</a> 懒标记</h2><p>在<strong>区间查询</strong>中，只要发现<strong>当前搜索到的区间</strong>已经包含了<strong>需要查询的区间</strong>就可以直接返回结果。</p><p><strong>区间修改</strong>同样可以使用类似的思路。<strong>只要 当前搜索到的区间 已经包含了 需要修改的区间，就不再继续搜索，而是在当前搜索的区间打一个标记 add</strong>。</p><blockquote><p>懒标记 <code>add</code> ：表示给每一个以当前节点为根的子树中的每个节点都加上 <code>add</code> （不包含当前节点自己）。</p></blockquote><p><img data-src="/assets/60a3c03a-35fe-4916-95fc-58e426edff8f.png" alt=""><br>如上图所示的线段树中，我们<strong>给六号节点添加了一个标记 add，表示这个区间内的数增加了 add，但是这个标记 并没有向下传播，而是在添加标记后就认为是完成了这次 区间修改</strong>。如此一来，<strong>区间修改</strong>的时间复杂度变的和<strong>区间查询</strong>一致，同是 O (logn) 级别。</p><h2 id="带有懒标记的查询"><a class="anchor" href="#带有懒标记的查询">#</a> 带有懒标记的查询</h2><p>在使用了懒标记之后，在查询的过程中就需要计算上标记的值。</p><p><img data-src="/assets/9da2f7dc-3117-4361-8d15-39b36fff605a.png" alt=""></p><p>假如需要查询的区间是 <code>[8,9]</code> ，我们发现节点 <code>[8,8]</code> 的父节点上有一个 <code>add</code> 标记，所以在 <code>[8,8]</code> 上也要相应的增加 <code>add</code> ，那么查询的结果才能正确。</p><p>如何做到这一点呢？方法是<strong>在查询的过程中 把节点上的标记 向下传递并且清空</strong>，我们称这一操作为 <code>pushdown</code> ，也就是上一篇文章中提到的<strong>由父节点更新子节点</strong>。</p><p>举个例子，假如我们<strong>查询到了六号节点 <code>[6,8]</code> ，发现了它的身上有 <code>add</code> 标记，就把这个标记向下传递，让它的子节点 (12,13) 增加相应的值，再将六号节点上的标记清空掉</strong>。</p><p>这样就<strong>保证了在计算当前节点的时候，它的所有祖宗节点上的标记都已经累加到了当前节点</strong>。也就是说 我们查询到 13 号节点的时候，它的六号父节点上的 add 标记已经计算到 13 号节点上了。</p><h2 id="累加标记到子节点"><a class="anchor" href="#累加标记到子节点">#</a> 累加标记到子节点</h2><p>假设线段树中维护的信息是<strong>区间和</strong>。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 父节点的标记传递到子节点</span></pre></td></tr><tr><td data-num="2"></td><td><pre>left<span class="token punctuation">.</span>add <span class="token operator">+=</span> root<span class="token punctuation">.</span>add<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 维护子节点总和 需要把子节点对应的区间内 每一个数都加上 add</span></pre></td></tr><tr><td data-num="4"></td><td><pre>left<span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>left<span class="token punctuation">.</span>R <span class="token operator">-</span> left<span class="token punctuation">.</span>L <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> root<span class="token punctuation">.</span>add<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 用相同的方法把标记传到右子节点</span></pre></td></tr><tr><td data-num="7"></td><td><pre>right<span class="token punctuation">.</span>add <span class="token operator">+=</span> root<span class="token punctuation">.</span>add<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>right<span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>right<span class="token punctuation">.</span>R <span class="token operator">-</span> right<span class="token punctuation">.</span>L <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> root<span class="token punctuation">.</span>add<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 清空父节点的标记</span></pre></td></tr><tr><td data-num="11"></td><td><pre>root<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>需要注意的一点是<strong>不但要在查询的时候加入 pushdown，在修改的使用同样也需要加入该操作 (pushdown)。</strong></p><p>试想一下，如果我们给区间 <code>[6,9]</code> 增加了 10 之后，又要给区间 <code>[8,9]</code> 增加 5，假如第二次修改时，标记 10 还没有传递出去，那么会出现区间 <code>[6,9]</code> 一半需要加 10，一半需要加 15，造成冲突，产生错误。</p><h1 id="acwing-243-一个简单的整数问题2"><a class="anchor" href="#acwing-243-一个简单的整数问题2">#</a> <span class="exturl" data-url="aHR0cHM6Ly93d3cuYWN3aW5nLmNvbS9wcm9ibGVtL2NvbnRlbnQvMjQ0Lw==">AcWing 243. 一个简单的整数问题 2</span></h1><blockquote><p>给定一个长度为 N 的数列 A，以及 M 条指令，每条指令可能是以下两种之一：</p><ol><li>C l r d，表示把 A [l],A [l+1],…,A [r] 都加上 d。</li><li>Q l r，表示询问数列中第 l∼r 个数的和。<br>对于每个询问，输出一个整数表示答案。</li></ol><p><strong>输入格式</strong></p><p>第一行两个整数 N,M。</p><p>第二行 N 个整数 A [i]。</p><p>接下来 M 行表示 M 条指令，每条指令的格式如题目描述所示。</p><p><strong>输出格式</strong></p><p>对于每个询问，输出一个整数表示答案。</p><p>每个答案占一行。</p><p><strong>数据范围</strong></p><pre><code>1≤N,M≤10^5,
|d|≤10000,
|A[i]|≤10^9
</code></pre><p><strong>输入样例</strong></p><pre><code>10 5
1 2 3 4 5 6 7 8 9 10
Q 4 4
Q 1 10
Q 2 4
C 3 6 3
Q 2 4
</code></pre><p><strong>输出样例</strong></p><pre><code>4
55
9
15
</code></pre></blockquote><h2 id="题目描述"><a class="anchor" href="#题目描述">#</a> 题目描述</h2><p>给出一个长度为 N 的数列，给出两个操作：</p><ol><li>区间增加；</li><li>区间查询；</li></ol><h2 id="题目分析"><a class="anchor" href="#题目分析">#</a> 题目分析</h2><p>本题是一个模板题，我们先用这道题来熟悉一下<strong>带有懒标记的线段树</strong>。</p><p>线段树的代码很长，因此不好写，下面代码中两个 pushdown 的位置是需要特别关注的。</p><h2 id="code"><a class="anchor" href="#code">#</a> Code</h2><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">long</span> LL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">100010</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">int</span> l<span class="token punctuation">,</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    LL sum<span class="token punctuation">,</span> add<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span>tree<span class="token punctuation">[</span>N <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">int</span> w<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// 子节点计算父节点</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">void</span> <span class="token function">pushup</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">=</span> tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+</span> tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">void</span> <span class="token function">pushdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">auto</span> <span class="token operator">&amp;</span>root <span class="token operator">=</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>left <span class="token operator">=</span> tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>right <span class="token operator">=</span> tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>add<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 分析中的懒标记操作</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        left<span class="token punctuation">.</span>add <span class="token operator">+=</span> root<span class="token punctuation">.</span>add<span class="token punctuation">,</span> left<span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>LL<span class="token punctuation">)</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>r <span class="token operator">-</span> left<span class="token punctuation">.</span>l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> root<span class="token punctuation">.</span>add<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        right<span class="token punctuation">.</span>add <span class="token operator">+=</span> root<span class="token punctuation">.</span>add<span class="token punctuation">,</span> right<span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>LL<span class="token punctuation">)</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span>r <span class="token operator">-</span> right<span class="token punctuation">.</span>l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> root<span class="token punctuation">.</span>add<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        root<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// 初始化 所有叶子节点</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> r<span class="token punctuation">)</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> w<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">=</span> l<span class="token punctuation">,</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">=</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">int</span> mid <span class="token operator">=</span> l <span class="token operator">+</span> r <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 计算 mid</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">// 递归左右</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token function">build</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">build</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function">pushup</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">// 区间修改</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">void</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// 找到了需要 修改的区间</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">>=</span> l <span class="token operator">and</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">&lt;=</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// 修改该区间 并且增加懒标记</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">-</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> v<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>add <span class="token operator">+=</span> v<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token comment">// 注意 此处必须优先 pushdown</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token function">pushdown</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">int</span> mid <span class="token operator">=</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">+</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token function">modify</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">></span> mid<span class="token punctuation">)</span> <span class="token function">modify</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token comment">// 注意 此处必须 pushup</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token function">pushup</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>LL <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">>=</span> l <span class="token operator">and</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">&lt;=</span> r<span class="token punctuation">)</span> <span class="token keyword">return</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// 注意 此处必须优先 pushdown</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token function">pushdown</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">int</span> mid <span class="token operator">=</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">+</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    LL sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">// 计算 查询区间的总和</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> sum <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">></span> mid<span class="token punctuation">)</span> sum <span class="token operator">+=</span> <span class="token function">query</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">return</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token function">build</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">char</span> op<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">int</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> v<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>m <span class="token operator">--</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s%d%d"</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>op <span class="token operator">==</span> <span class="token char">'C'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            <span class="token function">modify</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%lld\n"</span><span class="token punctuation">,</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="acwing-1277-维护序列"><a class="anchor" href="#acwing-1277-维护序列">#</a> <span class="exturl" data-url="aHR0cHM6Ly93d3cuYWN3aW5nLmNvbS9wcm9ibGVtL2NvbnRlbnQvMTI3OS8=">AcWing 1277. 维护序列</span></h1><blockquote><p>老师交给小可可一个维护数列的任务，现在小可可希望你来帮他完成。</p><p>有长为 N 的数列，不妨设为 a1,a2,…,aN。</p><p>有如下三种操作形式：</p><p>把数列中的一段数全部乘一个值；<br>把数列中的一段数全部加一个值；<br>询问数列中的一段数的和，由于答案可能很大，你只需输出这个数模 P 的值。</p><p><strong>输入格式</strong></p><p>第一行两个整数 N 和 P；</p><p>第二行含有 N 个非负整数，从左到右依次为 a1,a2,…,aN；</p><p>第三行有一个整数 M，表示操作总数；</p><p>从第四行开始每行描述一个操作，输入的操作有以下三种形式：</p><ol><li><code>1 t g c</code> ，表示把所有满足 t≤i≤g 的 ai 改为 ai×c；</li><li><code>2 t g c</code> ，表示把所有满足 t≤i≤g 的 ai 改为 ai+c；</li><li><code>3 t g</code> ，询问所有满足 t≤i≤g 的 ai 的和模 P 的值。<br>同一行相邻两数之间用一个空格隔开，每行开头和末尾没有多余空格。</li></ol><p><strong>输出格式</strong></p><p>对每个操作 3，按照它在输入中出现的顺序，依次输出一行一个整数表示询问结果。</p><p><strong>数据范围</strong></p><pre><code>1≤N,M≤10^5,
1≤t≤g≤N,
0≤c,ai≤10^9,
1≤P≤10^9
</code></pre><p><strong>输入样例</strong></p><pre><code>7 43
1 2 3 4 5 6 7
5
1 2 5 5
3 2 4
2 3 7 9
3 1 3
3 4 7
</code></pre><p><strong>输出样例</strong></p><pre><code>2
35
8
</code></pre></blockquote><h2 id="题目描述-2"><a class="anchor" href="#题目描述-2">#</a> 题目描述</h2><p>与上题相似，同样是给出一个序列，进行操作，本题有三种操作方式：</p><ol><li>给某段区间 [l,r] 增加一个数；</li><li>给某段区间 [l,r] 乘以一个数；</li><li>查询某段区间的和；</li></ol><h2 id="题目分析-2"><a class="anchor" href="#题目分析-2">#</a> 题目分析</h2><p>标准的线段树模板题。</p><hr><p>要思考的第一个问题是<strong>如何既能计算加法又能计算乘法</strong>呢？</p><p>可以考虑<strong>使用两个懒标记</strong>，一个表示加法，一个表示乘法。</p><p>如此，本题就变成了标准的线段树模板，只是在 pushdown 里面，我们需要维护两个懒标记。</p><hr><p>既然是两个懒标记，就会出现计算顺序的问题，考虑下面的问题：<br><img data-src="/assets/e2561eba-618d-4eed-8459-e7ca8e4cc572.png" alt=""><br>对于给出线段树，我们执行三个操作：</p><ol><li>对区间 [1,2,3] 进行 +3；</li><li>对区间 [1,2,3] 进行 *3；</li><li>对区间 [1,2,3] 进行 +3；</li></ol><p>也就是我们的标记变化为：</p><ol><li><code>add += 3, sum += ((3-1)+1)*3</code> ，其中 sum 表示题目求的区间和；</li><li><code>mult *= 3</code> ；</li><li><code>add += 3</code> ；</li></ol><p>那么问题来了，操作 2 执行之后，sum 的值是： <code>(a[1]+3)*3 + (a[2]+3)*3 + (a[3]+3)*3</code></p><p>到了操作 3 之后，因为<strong> add 标记只有一个</strong>，所以再加 3 会变成：</p><p><code>(a[1]+3+3)*3 + (a[2]+3+3)*3 + (a[3]+3+3)*3</code></p><p>也就是<strong>两个 + 3</strong> 共同组成了 add 标记，但是这样显然是不对的，因为我们期待的公式是这样的：</p><p><code>(a[1]+3)*3+3 + (a[2]+3)*3+3 + (a[3]+3)*3+3</code></p><p>为什么会出现这种情况呢？因为我们一次计算中，同时计算了两个标记，这两个标记是<strong>没有先后顺序</strong>的。</p><p>那么，如何避免这种矛盾出现呢？很简单，对于<strong>标记的计算</strong>遵守<strong>先乘后加</strong>的原则。也就是说，我们让操作 2 计算之后变成这样：</p><p><code>a[1]*3+3 + a[2]*3+3 + a[3]*3+3</code></p><p>如此，当执行操作 3，计算第二个 <code>+3</code> 的时候，公式就会变成我们期待的样子：</p><p><code>a[1]*3+3+3 + a[2]*3+3+3 + a[3]*3+3+3</code></p><h2 id="code-2"><a class="anchor" href="#code-2">#</a> Code</h2><p>在实现上还有一个小细节需要注意，add 标记的初始值是 0，而 mult 的初始值不能是 0，需要设置成 1，因为 0 会把所有和它想乘的，都变成 0。</p><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">long</span> LL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">100010</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> l<span class="token punctuation">,</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">int</span> add<span class="token punctuation">,</span> mult<span class="token punctuation">,</span> sum<span class="token punctuation">;</span> <span class="token comment">// 加法标记 乘法标记 区间和</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span>tree<span class="token punctuation">[</span>N <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">,</span> P<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">int</span> w<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// 我们把更新操作单独拿出来 因为在 修改 指定区间 的时候</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// 需要单独做一次修改（不使用 pushdown）</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span>Node <span class="token operator">&amp;</span>u<span class="token punctuation">,</span> <span class="token keyword">int</span> add<span class="token punctuation">,</span> <span class="token keyword">int</span> mult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 修改一段区间 乘法直接用 区间和 乘以标记 mult</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 加法 需要让区间 [l,r] 中所有元素都加上标记 add</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    u<span class="token punctuation">.</span>sum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LL<span class="token punctuation">)</span>u<span class="token punctuation">.</span>sum <span class="token operator">*</span> mult <span class="token operator">+</span> <span class="token punctuation">(</span>LL<span class="token punctuation">)</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>r <span class="token operator">-</span> u<span class="token punctuation">.</span>l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> add<span class="token punctuation">)</span> <span class="token operator">%</span> P<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    u<span class="token punctuation">.</span>mult <span class="token operator">=</span> <span class="token punctuation">(</span>LL<span class="token punctuation">)</span>u<span class="token punctuation">.</span>mult <span class="token operator">*</span> mult <span class="token operator">%</span> P<span class="token punctuation">;</span>  <span class="token comment">// 乘法更新标记</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    u<span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LL<span class="token punctuation">)</span>u<span class="token punctuation">.</span>add <span class="token operator">*</span> mult <span class="token operator">+</span> add<span class="token punctuation">)</span> <span class="token operator">%</span> P<span class="token punctuation">;</span>  <span class="token comment">// 加法更新标记 注意先乘后加规则</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// 父节点 计算两个子节点</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">void</span> <span class="token function">pushdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 计算两个子节点 并 清空当前节点</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">eval</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>add<span class="token punctuation">,</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>mult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">eval</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>add<span class="token punctuation">,</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>mult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>add <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>mult <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">// 子节点区间和 计算 父节点区间和</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">void</span> <span class="token function">pushup</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">=</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+</span> tree<span class="token punctuation">[</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">)</span> <span class="token operator">%</span> P<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">// 建树模板</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> r<span class="token punctuation">)</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> w<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 注意这里乘法标记初始化是 1</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">int</span> mid <span class="token operator">=</span> l <span class="token operator">+</span> r <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token function">build</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">build</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token function">pushup</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">// 修改模板</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">void</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> add<span class="token punctuation">,</span> <span class="token keyword">int</span> mult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token comment">// 找到指定的修改区间  进行一次计算 修改掉指定区间的值 并且更新标记</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">and</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">&lt;=</span> r<span class="token punctuation">)</span> <span class="token function">eval</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> add<span class="token punctuation">,</span> mult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token function">pushdown</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意 pushdown 的位置</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">int</span> mid <span class="token operator">=</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">+</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token function">modify</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> add<span class="token punctuation">,</span> mult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">></span> mid<span class="token punctuation">)</span> <span class="token function">modify</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> add<span class="token punctuation">,</span> mult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token function">pushup</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 注意 pushup 的位置</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token comment">// 查询模板</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token keyword">int</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">and</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">&lt;=</span> r<span class="token punctuation">)</span> <span class="token keyword">return</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token function">pushdown</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 注意 pushdown 的位置</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">int</span> mid <span class="token operator">=</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">+</span> tree<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> res <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">></span> mid<span class="token punctuation">)</span> res <span class="token operator">=</span> <span class="token punctuation">(</span>res <span class="token operator">+</span> <span class="token function">query</span><span class="token punctuation">(</span>u <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> P<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    cin <span class="token operator">>></span> n <span class="token operator">>></span> P<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token function">build</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    cin <span class="token operator">>></span> m<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>m <span class="token operator">--</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token keyword">int</span> t<span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token function">modify</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            <span class="token function">modify</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="总结"><a class="anchor" href="#总结">#</a> 总结</h1><p>线段树的入门攻略，目前预计总共就这两篇文章，除开基本讲解外总共五道题。</p><p>总体来讲，难度还是超过了预期的，但是仍然有迹可循，整个模板的大部分代码都是固定的，最大的难点在于细节的处理以及 <code>pushdown</code> 和 <code>pushup</code> 的计算。</p><p>因此，使用线段树的时候，可以按照下面的顺序思考：</p><ol><li><p>线段树节点里维护的主要信息是什么？维护该信息的计算时候，是否需要额外的辅助属性也存储在节点中？</p></li><li><p>计算节点信息的方法？计算 pushdown 和 pushup 的方法？计算的时候是否需要使用 <code>long long</code> ？</p></li><li><p>修改和查询的时候必须注意 pushdown 和 pushup 的位置。</p></li><li><p>背熟模板代码，起码在模板部分不要出错误。</p></li></ol><p><strong>END</strong></p><div class="tags"><a href="/tags/%E7%BB%8F%E5%85%B8%E5%BF%85%E4%BC%9A/" rel="tag"><i class="ic i-tag"></i> 经典必会</a> <a href="/tags/AcWing%E7%AE%97%E6%B3%95%E6%8F%90%E9%AB%98%E8%AF%BE/" rel="tag"><i class="ic i-tag"></i> AcWing算法提高课</a> <a href="/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91/" rel="tag"><i class="ic i-tag"></i> 线段树</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-11-11 18:31:40" itemprop="dateModified" datetime="2022-11-11T18:31:40+08:00">2022-11-11</time> </span><span id="看完必会的线段树攻略2.0（下）/" class="item leancloud_visitors" data-flag-title="看完必会的线段树攻略2.0（下）" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/images/wechatpay.png" alt="A Cat Without Sugar 微信支付"><p>微信支付</p></div><div><img data-src="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/images/alipay.png" alt="A Cat Without Sugar 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>A Cat Without Sugar <i class="ic i-at"><em>@</em></i>小猫咪吃python</li><li class="link"><strong>本文链接：</strong> <a href="http://yoursite.com/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%94%BB%E7%95%A52.0%EF%BC%88%E4%B8%8B%EF%BC%89/" title="看完必会的线段树攻略2.0（下）">http://yoursite.com/看完必会的线段树攻略2.0（下）/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%94%BB%E7%95%A52.0%EF%BC%88%E4%B8%8A%EF%BC%89/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevo9j1jj20zk0m8e81.jpg" title="看完必会的线段树攻略2.0（上）"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 数据结构</span><h3>看完必会的线段树攻略2.0（上）</h3></a></div><div class="item right"><a href="/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%91%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E5%AD%97%E5%85%B8%E6%A0%91%E6%94%BB%E7%95%A5/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclg5ms2rj20zk0m8u0x.jpg" title="看完必会的字典树攻略"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 数据结构</span><h3>看完必会的字典树攻略</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E6%AE%B5%E6%A0%91"><span class="toc-number">2.</span> <span class="toc-text">线段树</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%87%92%E6%A0%87%E8%AE%B0"><span class="toc-number">2.1.</span> <span class="toc-text">懒标记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%A6%E6%9C%89%E6%87%92%E6%A0%87%E8%AE%B0%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.2.</span> <span class="toc-text">带有懒标记的查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%AF%E5%8A%A0%E6%A0%87%E8%AE%B0%E5%88%B0%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-number">2.3.</span> <span class="toc-text">累加标记到子节点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#acwing-243-%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%B4%E6%95%B0%E9%97%AE%E9%A2%982"><span class="toc-number">3.</span> <span class="toc-text">AcWing 243. 一个简单的整数问题 2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#code"><span class="toc-number">3.3.</span> <span class="toc-text">Code</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#acwing-1277-%E7%BB%B4%E6%8A%A4%E5%BA%8F%E5%88%97"><span class="toc-number">4.</span> <span class="toc-text">AcWing 1277. 维护序列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0-2"><span class="toc-number">4.1.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-2"><span class="toc-number">4.2.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#code-2"><span class="toc-number">4.3.</span> <span class="toc-text">Code</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E5%85%A5%E9%97%A8%E6%94%BB%E7%95%A5/" rel="bookmark" title="看完必会的滑动窗口入门攻略">看完必会的滑动窗口入门攻略</a></li><li><a href="/AcWing%20240.%20%E9%A3%9F%E7%89%A9%E9%93%BE%EF%BC%88%E8%B6%85%E6%9C%89%E8%B6%A3%E7%9A%84%E5%B9%B6%E6%9F%A5%E9%9B%86%E9%A2%98%E7%9B%AE%EF%BC%89/" rel="bookmark" title="AcWing 240. 食物链（超有趣的并查集题目）">AcWing 240. 食物链（超有趣的并查集题目）</a></li><li><a href="/%E6%9C%89%E8%B6%A3%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BA%8C%E5%8F%89%E5%A0%86%E7%9A%84%E5%AE%9E%E7%8E%B0/" rel="bookmark" title="有趣的数据结构-二叉堆的实现">有趣的数据结构-二叉堆的实现</a></li><li><a href="/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E5%B9%B6%E6%9F%A5%E9%9B%86%E6%94%BB%E7%95%A5/" rel="bookmark" title="看完必会的并查集入门攻略">看完必会的并查集入门攻略</a></li><li><a href="/%E5%B9%B6%E6%9F%A5%E9%9B%86%E7%9A%84%E5%AE%9E%E6%88%98%E5%88%86%E6%9E%90%E5%92%8C%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" rel="bookmark" title="并查集的实战分析和基础应用">并查集的实战分析和基础应用</a></li><li><a href="/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%80%9D%E8%B7%AF%E5%92%8C%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" rel="bookmark" title="树状数组的基本思路和简单实现">树状数组的基本思路和简单实现</a></li><li><a href="/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84%E7%9A%84%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/" rel="bookmark" title="树状数组的实战应用">树状数组的实战应用</a></li><li><a href="/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%94%BB%E7%95%A52.0%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="bookmark" title="看完必会的线段树攻略2.0（上）">看完必会的线段树攻略2.0（上）</a></li><li class="active"><a href="/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%94%BB%E7%95%A52.0%EF%BC%88%E4%B8%8B%EF%BC%89/" rel="bookmark" title="看完必会的线段树攻略2.0（下）">看完必会的线段树攻略2.0（下）</a></li><li><a href="/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%91%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E5%AD%97%E5%85%B8%E6%A0%91%E6%94%BB%E7%95%A5/" rel="bookmark" title="看完必会的字典树攻略">看完必会的字典树攻略</a></li><li><a href="/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%91%E5%8F%AF%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" rel="bookmark" title="可持久化数据结构的基础应用">可持久化数据结构的基础应用</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="A Cat Without Sugar" data-src="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/images/avatar.jpg"><p class="name" itemprop="name">A Cat Without Sugar</p><div class="description" itemprop="description">孤独与剑，自由与酒</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">64</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">10</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">78</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%94%BB%E7%95%A52.0%EF%BC%88%E4%B8%8A%EF%BC%89/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%91%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E5%AD%97%E5%85%B8%E6%A0%91%E6%94%BB%E7%95%A5/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/python/" title="分类于 python">python</a></div><span><a href="/python%E4%B8%AD%E7%9A%84%E7%94%9F%E6%88%90%E5%99%A8(yield%E4%B8%8Eyield%20from)/" title="python中的生成器(yield与yield from)">python中的生成器(yield与yield from)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%9B%BE%E8%AE%BA/" title="分类于 图论">图论</a></div><span><a href="/%E5%9B%BE%E8%AE%BA%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%9F%93%E8%89%B2%E6%B3%95%E5%88%A4%E5%AE%9A%E4%BA%8C%E5%88%86%E5%9B%BE/" title="图论基础之染色法判定二分图">图论基础之染色法判定二分图</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E4%B9%A6%E7%B1%8D%E6%8E%A8%E8%8D%90/" title="分类于 书籍推荐">书籍推荐</a></div><span><a href="/%E8%B6%85%E7%BA%A7%E5%8A%A0%E5%80%8D%E6%8E%A8%E8%8D%90%E4%B8%80%E6%9C%AC%E8%B6%A3%E5%91%B3%E7%A7%91%E6%99%AE%E7%B1%BB%E7%9A%84%E4%B9%A6--%E3%80%8A%E7%8C%AB%EF%BC%8C%E7%88%B1%E5%9B%A0%E6%96%AF%E5%9D%A6%E5%92%8C%E5%AF%86%E7%A0%81%E5%AD%A6%E3%80%8B/" title="推荐一本书《猫，爱因斯坦和密码学》">推荐一本书《猫，爱因斯坦和密码学》</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E6%95%B0%E5%AD%A6/" title="分类于 数学">数学</a></div><span><a href="/%E7%A5%9E%E5%A5%87%E7%9A%84%E5%BF%AB%E9%80%9F%E5%B9%82/" title="神奇的快速幂">神奇的快速幂</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E6%95%B0%E5%AD%A6/" title="分类于 数学">数学</a></div><span><a href="/%E6%AC%A7%E5%87%A0%E9%87%8C%E5%BE%B7%E7%AE%97%E6%B3%95%E5%8F%8A%E5%85%B6%E6%89%A9%E5%B1%95/" title="欧几里得算法及其扩展">欧几里得算法及其扩展</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="分类于 动态规划">动态规划</a></div><span><a href="/AcWing%20338.%20%E8%AE%A1%E6%95%B0%E9%97%AE%E9%A2%98/" title="AcWing 338. 计数问题">AcWing 338. 计数问题</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%9B%BE%E8%AE%BA/" title="分类于 图论">图论</a></div><span><a href="/%E5%8D%95%E6%BA%90%E6%9C%80%E7%9F%AD%E8%B7%AF%E4%B8%AD%E7%9A%84%E5%B8%B8%E7%94%A8%E5%BB%BA%E5%9B%BE%E6%96%B9%E5%BC%8F%E5%8F%8A%E6%9C%80%E7%9F%AD%E8%B7%AF%E7%AE%97%E6%B3%95%E6%A8%A1%E6%9D%BF%E5%BA%94%E7%94%A8/" title="单源最短路中的常用建图方式及最短路算法模板应用">单源最短路中的常用建图方式及最短路算法模板应用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="分类于 动态规划">动态规划</a></div><span><a href="/%E7%9C%8B%E5%AE%8C%E5%BF%85%E4%BC%9A%E7%9A%84%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97%E4%BC%98%E5%8C%96DP%E6%94%BB%E7%95%A5/" title="看完必会的单调队列优化DP攻略">看完必会的单调队列优化DP攻略</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E6%95%B0%E5%AD%A6/" title="分类于 数学">数学</a></div><span><a href="/%E9%AB%98%E6%96%AF%E6%B6%88%E5%85%83%E8%A7%A3%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84/" title="高斯消元解线性方程组">高斯消元解线性方程组</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E6%95%B0%E5%AD%A6/" title="分类于 数学">数学</a></div><span><a href="/%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8D%9A%E5%BC%88%E8%AE%BA%E9%97%AE%E9%A2%98(%E4%BA%8C)/" title="有趣的博弈论问题(二)">有趣的博弈论问题(二)</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">A Cat Without Sugar @ The Cat to eat Python</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">358k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:26</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"看完必会的线段树攻略2.0（下）/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="//cdn.jsdelivr.net/gh/cjrzs/KittenToEatPython@latest/js/app.js?v=0.2.5"></script></body></html>